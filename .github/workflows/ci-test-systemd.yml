name: ci-test-systemd

on:
  push:
    branches: [main]
    paths:
      - "KubeArmor/**"
      - "tests/**"
      - "protobuf/**"
      - ".github/workflows/ci-test-systemd.yml"
  pull_request:
    branches: [main]
    paths:
      - "KubeArmor/**"
      - "tests/**"
      - "protobuf/**"
      - ".github/workflows/ci-test-systemd.yml"

# Declare default permissions as read only.
permissions: read-all

jobs:
  build:
    name: Test KubeArmor in Systemd Mode
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'KubeArmor/go.mod'

      - name: Install the latest LLVM toolchain
        run: ./.github/workflows/install-llvm.sh

      - name: Compile libbpf
        run: ./.github/workflows/install-libbpf.sh

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Build Coverage Test Binary
        working-directory: KubeArmor
        run: make build-coverage

      - name: Run KubeArmor
        working-directory: KubeArmor
        run: |
          REPO_ROOT="$(pwd)"
          CONFIG_PATH="$REPO_ROOT/packaging/kubearmor.yaml"

          echo "Using config: $CONFIG_PATH"
          test -f "$CONFIG_PATH" && echo "Config file found" || (echo "Config file NOT found!" && exit 1)

          sudo env KUBEARMOR_CFG="$CONFIG_PATH" \
              ./kubearmor \
              -logPath=/tmp/kubearmor.log \
              -test.coverprofile=systemd_coverage.out \
              > /tmp/kubearmor.out 2>&1 &

          echo $! > kubearmor.pid
          echo "KubeArmor PID: $(cat kubearmor.pid)"

          sleep 15

      - name: Test KubeArmor using Ginkgo
        working-directory: ./tests/nonk8s_env
        run: |
          go install -mod=mod github.com/onsi/ginkgo/v2/ginkgo
          make
        timeout-minutes: 30

      - name: Stop KubeArmor
        working-directory: KubeArmor
        if: always()
        run: |
          echo "KubeArmor Process:"
          ps aux | grep kubearmor

          sudo pkill kubearmor

          for i in {1..30}; do
            if [ ! -f kubearmor.pid ]; then break; fi
            if ! ps -p $(cat kubearmor.pid) > /dev/null; then break; fi
            sleep 1
          done
          rm -f kubearmor.pid || true

      - name: Measure code coverage
        working-directory: KubeArmor
        if: always()
        run: |
          ls -l .
          for i in {1..5}; do
            if [ -f systemd_coverage.out ]; then
              go tool cover -func systemd_coverage.out
              break
            fi
            echo "systemd_coverage.out not found yet, retrying ($i/5)..."
            sleep 5
          done

      - name: Archive log artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: runtime_logs
          path: |
            /tmp/kubearmor.*
          if-no-files-found: ignore

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage_reports
          path: |
            KubeArmor/systemd_coverage.out
          if-no-files-found: ignore
